<?php

/**
 * @file
 * Primary module hooks for NYS Registration module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use SendGrid\Mail\From;
use SendGrid\Mail\Mail;
use SendGrid\Mail\Personalization;
use SendGrid\Mail\To;

/**
 * Implements hook_entity_type_alter().
 *
 * Replace the core user registration form with our custom multi-step version.
 */
function nys_registration_entity_type_alter(array &$entity_types): void {
  if ($user = ($entity_types['user'] ?? NULL)) {
    $user->setFormClass('register', 'Drupal\nys_registration\Form\RegisterForm');
  }
}

/**
 * Implements hook_theme().
 */
function nys_registration_theme($existing, $type, $theme, $path) {
  return [
    'register_form_step2' => [
      'render element' => 'form',
    ],
    'register_form_step3' => [
      'render element' => 'form',
    ],
    'register_form_step2_not_found' => [
      'render element' => 'form',
    ],
  ];
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function nys_registration_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['#attributes']['class'][] = 'registration-form';

  $form['registration_block_opener'] = [
    '#markup' => '<div class="c-block c-login">',
    '#weight' => 91,
    '#attached' => [
      'library' => [
        'nysenate_theme/registration-form',
      ],
    ],
  ];

  // Get config values.
  $nys_config = \Drupal::configFactory()->get('nys_config.settings');
  $header = $nys_config->get('user_login_header');
  $body = $nys_config->get('user_login_body');
  $footer = $nys_config->get('user_login_footer');

  $form['registration_teaser'] = [
    '#markup' => '
      <div class="c-login-left">
        <h3 class="nys-title">' . $header . '</h3>
        ' . $body . '
        <a href="/user/register" class="c-block--btn c-login-create">Create Account</a>
        ' . $footer . '
      </div>',
    '#weight' => 95,
  ];

  $form['login_right_top'] = [
    '#weight' => 96,
    '#markup' => '<div class="c-login-right"><h3 class="nys-title">' . t('I already have an account...') . '</h3>',
  ];

  $form['name']['#weight'] = 97;
  $form['pass']['#weight'] = 98;

  $form['actions']['submit'] = [
    '#value' => 'Log in to account',
    '#type' => 'submit',
    '#attributes' => ['class' => ['c-block--btn']],
    '#weight' => 100,
  ];

  $form['login_right_bottom'] = [
    '#weight' => 10001,
    '#markup' => '</div>',
  ];

  $form['registration_block_closer'] = [
    '#weight' => 10002,
    '#markup' => '</div>',
  ];

  // Redirect form to referrer if from modal.
  $form['#submit'][] = 'nys_registration_user_login_form_submit';
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function nys_registration_form_user_pass_reset_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Redirect the submit action to the custom function.
  $form['#action'] = '/nys' . $form['#action'];
}

/**
 * Custom submit handler for the login form.
 */
function nys_registration_user_login_form_submit($form, FormStateInterface $form_state) {
  $url = \Drupal::request()->headers->get('referer');
  $referrer = explode('/', $url);

  if ((isset($referrer[3]) && $referrer[3] == 'user') &&
    (isset($referrer[4]) && $referrer[4] == 'login')) {
    // Redirect to the /dashboard page.
    $form_state->setRedirectUrl(Url::fromRoute('view.my_dashboard.main'));
  }
  else {
    $form_state->setRedirectUrl(Url::fromUri($url));
  }
}

/**
 * Implements hook_mail_alter().
 */
function nys_registration_mail_alter(&$message) {
  if ($message['key'] ?? '' === 'register_no_approval_required') {
    // Build the \SendGrid\Mail\Mail object.
    try {
      $from_mail = $message['from'] ?? '';
      $from = new From($from_mail, $from_mail);
      $mail = new Mail($from);

      // Set the SendGrid template ID.
      // @todo replace with new template ID.
      $mail->setTemplateId('5182d9b2-8670-41cb-9f65-5f671541907f');

      // Add the email variables.
      $personalization = new Personalization();
      /** @var \Drupal\user\Entity\User $account */
      $account = $message['params']['account'] ?? NULL;
      $user_first_name = $account?->field_first_name?->value;
      $user_reset_link = user_pass_reset_url($account);
      // @todo replace with new vars.
      $substitutions = [
        '%bill.base_print%' => $user_first_name,
        '%bill.session%' => $user_first_name,
        '%bill.print_number%' => $user_first_name,
        '%bill.chamber%' => $user_first_name,
        '%bill.summary%' => $user_first_name,
        '%bill.sponsor%' => $user_first_name,
        '%confirm_url%' => $user_reset_link,
      ];
      foreach ($substitutions as $s_key => $s_val) {
        $personalization->addSubstitution($s_key, $s_val);
      }
      $mail->addPersonalization($personalization);
    }
    catch (Throwable $e) {
      \Drupal::messenger()
        ->addError('There was an error sending the registration email. Please contact a site admin.');
      \Drupal::logger('nys_registration')
        ->error('Failed to build \SendGrid\Mail\Mail object for mail with key: register_no_approval_required.');
      $message['send'] = FALSE;
      return;
    }

    // Attach Mail object to $messages array, so that the email gets sent using
    // SendGrid template.
    $message['params']['sendgrid_mail'] = $mail;
  }
}
