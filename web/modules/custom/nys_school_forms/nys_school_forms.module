<?php

/**
 * @file
 * Custom functionality for the nys_school_forms module.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Form\FormStateInterface;
use Drupal\webform\WebformSubmissionInterface;

/**
 * @file
 * Custom functionality for the nys_school_forms module.
 */

/**
 * Implements hook_theme().
 */
function nys_school_forms_theme() {
  return [
    'school_forms' => [
      'variables' => [
        'search_form' => NULL,
        'entity_update_form' => NULL,
        'export_link' => NULL,
      ],
    ],
    'nys_school_forms__results_block' => [
      'variables' => [
        'content' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_ENTITY_TYPE_access() for webform submission entity.
 *
 * Provides access control for the webform submission entity.
 */
function nys_school_forms_webform_submission_access(WebformSubmissionInterface $webform_submission, $op, $account) {
  // Check if the user is anonymous.
  if ($account->isAnonymous()) {
    return AccessResult::forbidden();
  }

  // Allow authenticated users to access the webform submission.
  return AccessResult::allowed();
}

/**
 * Implements hook_form_FORM_ID_alter.
 */
function nys_school_forms_form_node_student_submission_container_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Set and hide form type field if default available from context.
  $current_path = \Drupal::requestStack()->getCurrentRequest()->getPathInfo();
  if ($current_path != '/node/add/student_submission_container') {
    $form['field_form_type']['#access'] = FALSE;
  }
  if ($current_path == '/questionnaires/what-are-you-thankful') {
    $form['field_form_type']['widget']['#default_value'] = 'thanksgiving';
  }
  elseif ($current_path == '/earthday') {
    $form['field_form_type']['widget']['#default_value'] = 'earth_day';
  }

  // Custom validation to make only one upload field required.
  array_unshift($form['#validate'], '_nys_school_forms_validate_ss_container_form');
}

/**
 * Implements hook_inline_entity_form_entity_form_alter.
 */
function nys_school_forms_inline_entity_form_entity_form_alter(&$form, FormStateInterface $form_state) {
  // Display image / file upload field based on prior selection.
  $upload_types = ['image', 'file'];
  foreach ($upload_types as $type) {
    $trigger = [":input[name='field_student_submissions[{$form['#ief_row_delta']}][inline_entity_form][field_upload_type]']" => ['value' => $type]];
    $form["field_{$type}_submission"]['#states'] = [
      'visible' => $trigger,
    ];
  }

  // Enable submission type field for thanksgiving form.
  $current_path = \Drupal::requestStack()->getCurrentRequest()->getPathInfo();
  if ($current_path == '/questionnaires/what-are-you-thankful') {
    $form['field_submission_type']['widget']['#required'] = TRUE;
  }
  elseif ($current_path == '/earthday') {
    $form['field_submission_type']['#access'] = FALSE;
  }
}

/**
 * Custom validation to make only one upload field required.
 */
function _nys_school_forms_validate_ss_container_form(array &$form, FormStateInterface $form_state) {
  $student_submissions = $form_state->getValue('field_student_submissions');
  $errors = $form_state->getErrors();
  unset($errors['submit']);
  $upload_types = ['image', 'file'];
  foreach ($upload_types as $type) {
    foreach ($student_submissions as $key => $submission) {
      if (
        !is_array($submission)
        || !isset($submission['inline_entity_form']['field_upload_type'][0]['value'])
      ) {
        continue;
      }
      $upload_type = $submission['inline_entity_form']['field_upload_type'][0]['value'];
      $field_key = "field_student_submissions][$key][inline_entity_form][field_{$type}_submission][0";
      if (
        $upload_type != $type
        && isset($errors[$field_key])
      ) {
        $form_state->clearErrors();
        unset($errors[$field_key]);
      }
    }
  }
  foreach ($errors as $field_name => $message) {
    $form_state->setErrorByName($field_name, $message);
  }
}
