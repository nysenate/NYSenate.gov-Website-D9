<?php

/**
 * @file
 * Provides global and advanced search functionality.
 */

use Drupal\nys_search\Form\GlobalSearchForm;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_views_pre_render().
 *
 * Dynamically updates the search results header with the search term from the URL.
 * Properly decodes URL-encoded search terms and handles empty search queries.
 */
function nys_search_views_pre_render(ViewExecutable $view) {
  if ($view->id() !== 'core_search') {
    return;
  }

  // Only process search results displays that have a header.
  if (!isset($view->header['result'])) {
    return;
  }

  // Extract the search term from the request.
  $search_term = _nys_search_extract_search_term();

  $current_content = $view->header['result']->options['content'] ?? '';

  if ($search_term !== NULL) {
    // Replace empty quotes placeholder with the search term (uppercase).
    $updated_content = str_replace('FOR ""', 'FOR "' . strtoupper($search_term) . '"', $current_content);
  } else {
    // Remove "FOR """ if no search term.
    $updated_content = str_replace('FOR ""', '', $current_content);
  }

  $view->header['result']->options['content'] = $updated_content;
}

/**
 * Extracts the search term from the current request.
 *
 * The extracted term is URL-decoded to handle encoded characters.
 *
 * @return string|null
 *   The decoded search term, or NULL if no search term could be extracted.
 */
function _nys_search_extract_search_term() {
  // Get the current request.
  $request = \Drupal::request();

  // Extract the search term from the full_text query parameter.
  $search_term = $request->query->get('full_text', '');

  // URL-decode and trim the search term.
  $search_term = urldecode($search_term);
  $search_term = trim($search_term);

  // Return NULL if the search term is empty, otherwise return the term.
  return empty($search_term) ? NULL : $search_term;
}

/**
 * Custom search submit function.
 */
function _nys_search_custom_search_submit($form, &$form_state) {
  $search_keyword = $form_state['values']['keys'];
  $form_state['redirect'] = '/search/global/' . $search_keyword;
}

/**
 * Implements hook_preprocess_page().
 */
function nys_search_preprocess_page(&$variables) {
  // Use lazy builder for the search form to allow page caching.
  // The form token will be rendered as a placeholder and filled in dynamically.
  $variables['form'] = [
    '#lazy_builder' => [
      'nys_search.search_form_lazy_builder:renderSearchForm',
      [],
    ],
    '#create_placeholder' => TRUE,
  ];
}

/**
 * Implements hook_form_alter().
 */
function nys_search_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Remove the unwanted "Global Search" title from the GlobalSearchAdvancedForm.
  if ($form_id === 'nys_search_global_form') {
    unset($form['global_search']);
  }
}
